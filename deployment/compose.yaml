version: "3.8"

services:
  # --- Gateway ---
  gateway:
    build:
      context: .
      dockerfile: Dockerfile.caddy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - caddy_data:/data
      - caddy_config:/config
      - ./did-logs:/usr/share/caddy/did:ro
      - ./dist-app:/usr/share/caddy/app:ro
    networks:
      - shared_pod

  # --- Static Content Hosts ---
  frontend-static:
    image: caddy:alpine
    command: caddy file-server --root /usr/share/caddy --listen :80
    volumes:
      - ./dist-app:/usr/share/caddy:ro
    networks:
      - shared_pod

  did-static:
    image: caddy:alpine
    command: caddy file-server --root /usr/share/caddy --listen :80
    volumes:
      - ./test-logs:/usr/share/caddy/.well-known/did:ro
    networks:
      - shared_pod

  # --- Data Layer ---
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASS}
      POSTGRES_DB: dpp_db
    volumes:
      - pg_data:/var/lib/postgresql/data
    networks:
      - shared_pod

  # --- Microservices ---
  identity:
    build:
      context: ..
      dockerfile: deployment/Dockerfile.identity
    ports:
      - "3000:3000"
    env_file: .env
    environment:
      - SERVICE_ROLE=identity
      - DB_HOST=postgres
      - STORAGE_ROOT=/var/www/did-logs
    depends_on:
      - postgres
    networks:
      - shared_pod
    volumes:
      - ./did-logs:/var/www/did-logs

  witness:
    build:
      context: ..
      dockerfile: deployment/Dockerfile.witness
    env_file: .env
    environment:
      - SERVICE_ROLE=witness
      - DB_HOST=postgres
      # RPC_URL is loaded from .env
    depends_on:
      - postgres
    networks:
      - shared_pod
    extra_hosts:
      - "host.docker.internal:host-gateway"

  watcher:
    build:
      context: ..
      dockerfile: deployment/Dockerfile.watcher
    env_file: .env
    environment:
      - SERVICE_ROLE=watcher
      - DB_HOST=postgres
      # RPC_URL is loaded from .env
      - STORAGE_ROOT=/var/www/did-logs
    depends_on:
      - postgres
    networks:
      - shared_pod
    volumes:
      - ./did-logs:/var/www/did-logs:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # --- Local Blockchain (Optional) ---
  # blockchain:
  #   image: ghcr.io/nomicfoundation/hardhat:latest
  #   command: ["npx", "hardhat", "node", "--hostname", "0.0.0.0"]
  #   ports:
  #     - "8545:8545"
  #   networks:
  #     - shared_pod

volumes:
  caddy_data:
  caddy_config:
  pg_data:

networks:
  shared_pod:
    driver: bridge
